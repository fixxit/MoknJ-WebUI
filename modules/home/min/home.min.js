"use strict";angular.module("Home").factory("ApiHomeCall",["$http",function($http){var service={};return service.process=function(url,payload,callback){$http.get("../settings.json").success(function(response){payload?$http({method:"POST",url:response.api_url+url,data:JSON.stringify(payload),headers:{"Content-Type":"application/json"}}).success(function(response){callback(response)}).error(function(response){callback(response)}):$http.post(response.api_url+url).success(function(response){callback(response)}).error(function(response){callback(response)})})},service}]),angular.module("Home").factory("HomeService",["ApiHomeCall",function(ApiHomeCall){var service={};return service.getAllTypes=function(token,callback){ApiHomeCall.process("type/all?access_token="+token,null,callback)},service.getAllMenus=function(token,callback){ApiHomeCall.process("menu/all?access_token="+token,null,callback)},service.getMenu=function(token,id,callback){ApiHomeCall.process("menu/get/"+id+"?access_token="+token,null,callback)},service.getAllAssetForType=function(token,templateId,menuId,callback){ApiHomeCall.process("asset/get/all/"+templateId+"/"+menuId+"?access_token="+token,null,callback)},service.getAllEmployeeForType=function(token,templateId,menuId,callback){ApiHomeCall.process("employee/get/all/"+templateId+"/"+menuId+"?access_token="+token,null,callback)},service.deleteAsset=function(token,payload,callback){ApiHomeCall.process("asset/delete/?access_token="+token,payload,callback)},service.deleteEmployee=function(token,payload,callback){ApiHomeCall.process("employee/delete/?access_token="+token,payload,callback)},service.addLink=function(token,payload,callback){ApiHomeCall.process("link/add?access_token="+token,payload,callback)},service.all=function(token,callback){ApiHomeCall.process("resource/get/all?access_token="+token,null,callback)},service.save=function(token,id,data,callback){ApiHomeCall.process("asset/add/"+id+"?access_token="+token,data,callback)},service.getResource=function(token,id,callback){ApiHomeCall.process("resource/get/"+id+"?access_token="+token,null,callback)},service}]),angular.module("Home").directive("chart",function(){var baseWidth=600,baseHeight=400;return{restrict:"E",template:"<canvas></canvas>",scope:{chartObject:"=value"},link:function(scope,element,attrs){var chart,canvas=element.find("canvas")[0],context=canvas.getContext("2d"),options={type:attrs.type||"Line",width:attrs.width||baseWidth,height:attrs.height||baseHeight};canvas.width=options.width,canvas.height=options.height,chart=new Chart(context),scope.$watch(function(){return element.attr("type")},function(value){if(value){options.type=value;var chartType=options.type;chart[chartType](scope.chartObject.data,scope.chartObject.options)}}),scope.$watch(function(){return scope.chartObject},function(value){if(value){var chartType=options.type;chart[chartType](scope.chartObject.data,scope.chartObject.options),scope.chartInstance&&scope.chartInstance.destroy(),scope.chartInstance=chart[chartType](scope.chartObject.data,scope.chartObject.options)}},!0)}}}),angular.module("Home").controller("HomeController",["$scope","$rootScope","$location","HomeService","$modal",function($scope,$rootScope,$location,HomeService,$modal){var data={labels:["January","February","March","April","May","June","July"],datasets:[{fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",data:[65,59,90,81,56,55,40]},{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:[28,48,40,19,96,27,100]}]};$scope.myChart=data,$scope.id=$location.search().id?$location.search().id:null,$scope.templateId=$location.search().templateId?$location.search().templateId:null,$scope.resourceId=$location.search().resourceId?$location.search().resourceId:null,$scope.name="Home",$scope.types={},$scope.selectedType=null,$scope.selectedResource=null,$scope.sortType="",$scope.sortReverse=!1,$scope.urls={user:"#/user",menu:"#/menu",create_menu_employee:"#/menu?new=true&type=GBL_MT_EMPLOYEE",create_menu_asset:"#/menu?new=true&type=GBL_MT_ASSET",graph:" #/graph",template:"#/type",hidden:"#/hidden_template",link:"#/link",employee_link:"#/employee_link",display_home_graphs:"../modules/graph/views/displaygraph.html"},$scope.modules={asset:{url:"../modules/templatetypes/views/asset/assetTableView.html",module:"GBL_TT_ASSET"},employee:{url:"../modules/templatetypes/views/employee/employeeTableView.html",module:"GBL_TT_EMPLOYEE"}},$scope.setURLs=function(id){id&&($scope.urls={user:"#/user?menuId="+id,menu:"#/menu?menuId="+id,create_menu_employee:"#/menu?new=true&type=GBL_MT_EMPLOYEE&menuId="+id,create_menu_asset:"#/menu?new=true&type=GBL_MT_ASSET&menuId="+id,graph:" #/graph?menuId="+id,template:"#/type?menuId="+id,hidden:"#/hidden_template?menuId="+id,link:"#/link?menuId="+id,employee_link:"#/employee_link?menuId="+id})},$scope.setFilter=function(detail,type){detail===type.sortType?(type.sortReverse=!type.sortReverse,type.sortType=detail):(type.sortReverse=!1,type.sortType=detail)},$scope.getTemplateEnties=function(type){type.templateType===$scope.modules.asset.module?HomeService.getAllAssetForType($rootScope.globals.currentUser.access_token,type.id,$scope.id,function(response){$scope.getModuleDetails(type,response)}):type.templateType===$scope.modules.employee.module&&HomeService.getAllEmployeeForType($rootScope.globals.currentUser.access_token,type.id,$scope.id,function(response){$scope.getModuleDetails(type,response)})},$scope.getFieldDetails=function(entries,type,values){entries&&angular.forEach(entries,function(entry){var fields=[];angular.forEach(type.details,function(detail){var noFieldFound=!0;if(angular.forEach(entry.details,function(field){detail.id===field.id&&(field.type=detail.type,"GBL_INPUT_DAT_TYPE"===field.type&&(field.value=$scope.formatDate(new Date(field.value))),fields.push(field),noFieldFound=!1)}),noFieldFound){var field={value:"n/a",type:"GBL_INPUT_TXT_TYPE"};fields.push(field)}}),entry.details=fields,values.push(entry)})},$scope.getModuleDetails=function(type,response){response&&(type.templateType===$scope.modules.asset.module?response.assets&&(type.loading=!0,type.assets=[],type.totalItems=response.assets.length,$scope.getFieldDetails(response.assets,type,type.assets),type.viewby=5,type.currentPage=1,type.itemsPerPage=type.viewby,type.maxSize=5,type.loading=!1,angular.forEach(response.assets,function(asset){$scope.loadResource(asset)})):type.templateType===$scope.modules.employee.module&&response.employees&&(type.loading=!0,type.employees=[],type.totalItems=response.employees.length,$scope.getFieldDetails(response.employees,type,type.employees),type.viewby=10,type.currentPage=1,type.itemsPerPage=type.viewby,type.maxSize=10,type.loading=!1,angular.forEach(response.employees,function(employee){$scope.loadResource(employee)})))},$scope.refreshAsset=function(asset,load_resource){angular.forEach($scope.types,function(type){type.id===asset.typeId&&angular.forEach(type.assets,function(type_asset){type_asset.id===asset.id&&(type_asset=asset,load_resource?$scope.loadResource(type_asset):(type_asset.linkedResource="unassigned",type_asset.resource={}))})})},$scope.removeAssetFromTemplate=function(typeId,remove){angular.forEach($scope.types,function(type){if(type.id===typeId){var index=0;angular.forEach(type.assets,function(asset){asset.id===remove.id&&type.assets.splice(index,1),index+=1})}})},$scope.removeEmployeeFromTemplate=function(typeId,remove){angular.forEach($scope.types,function(type){if(type.id===typeId){var index=0;angular.forEach(type.employees,function(employee){employee.id===remove.id&&type.employees.splice(index,1),index+=1})}})},$scope.formatDate=function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString();month=month.length>1?month:"0"+month;var day=date.getDate().toString();return day=day.length>1?day:"0"+day,year+"-"+month+"-"+day},$scope.loadResource=function(asset){asset.resourceId?HomeService.getResource($rootScope.globals.currentUser.access_token,asset.resourceId,function(response){response.error_description?$scope.error=response.error_description+". Please logout!":response.resource?(asset.linkedResource=response.resource.firstName+" "+response.resource.surname,asset.resource=response.resource):(asset.resource=null,asset.linkedResource="employee deleted")}):asset.linkedResource="unassigned"},$scope.loadAllResources=function(){HomeService.all($rootScope.globals.currentUser.access_token,function(response){response.error_description?$scope.error=response.error_description+". Please logout!":response.resources&&($scope.resources=response.resources,angular.forEach($scope.resources,function(resource){$scope.resourceId===resource.id&&($scope.selectedResource=resource)}))})},$scope.loadMenus=function(){HomeService.getAllMenus($rootScope.globals.currentUser.access_token,function(response){response.error_description?$scope.error=response.error_description+". Please logout!":response.menus&&($scope.menus=response.menus)})},$scope.loadTemplateForMenu=function(typeId){HomeService.getMenu($rootScope.globals.currentUser.access_token,$scope.id,function(response){response?response.error_description?"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!"):response.menu&&($scope.module=response.menu.menuType,$scope.name=response.menu.pageName,typeId||($scope.types=response.menu.templates),angular.forEach($scope.types,function(type){type.loading=!0,$scope.templateId===type.id&&($scope.selectedType=type,$scope.selectedType.newCollapse=!0),angular.forEach(type.details,function(detail){if("GBL_INPUT_DRP_TYPE"===detail.type){var n=detail.name.indexOf(":"),name=detail.name.substring(0,n);detail.name=name}}),typeId?type.id===typeId&&$scope.getTemplateEnties(type):$scope.getTemplateEnties(type),type.loading=!1}),$scope.dataLoading=!1):$scope.error="Oops! Something weird is going on... This page did not load. Please retry in 5 mins."})},$scope.loadPage=function(typeId){$scope.loadMenus(),$scope.loadAllResources(),$scope.id&&($scope.setURLs($scope.id),$scope.loadTemplateForMenu(typeId))},$scope.isEven=function(value){return value%2===0?"":"active"},$scope.isCollapsed=function(newCollapse){return newCollapse?"glyphicon glyphicon-resize-full":"glyphicon glyphicon-resize-small"},$scope.edit=function(id,assetId){$location.path("/asset").search({id:id,assetId:assetId,menuId:$scope.id})},$scope.editEmployee=function(id,employeeId){$location.path("/employee").search({id:id,employeeId:employeeId,menuId:$scope.id})},$scope.editType=function(id,origin){$location.path("/type").search({id:id,menuId:$scope.id,new:!0,origin:origin})},$scope.newAsset=function(id){$location.path("/asset").search({id:id,menuId:$scope.id})},$scope.newEmploye=function(id){$scope.selectedResource?$location.path("/employee").search({id:id,menuId:$scope.id,resourceId:$scope.selectedResource.id}):$location.path("/employee").search({id:id,menuId:$scope.id})},$scope.viewAudit=function(id,name){$location.path("/link").search({assetId:id,name:name,menuId:$scope.id})},$scope.viewEmployeeAudit=function(templateId,id,name){$location.path("/employee_link").search({id:templateId,employeeId:id,name:name,menuId:$scope.id})},$scope.removeAsset=function(asset,name,typeId){$modal.open({backdrop:!0,templateUrl:"../modules/templatetypes/asset/delete/deleteasset.html",controller:"ModalDeleteAssetCtrl",resolve:{parentScope:function(){return $scope},HomeService:function(){return HomeService},asset:function(){return asset},name:function(){return name},token:function(){return $rootScope.globals.currentUser.access_token},typeId:function(){return typeId}}})},$scope.removeEmployee=function(employee,name,typeId){$modal.open({backdrop:!0,templateUrl:"../modules/templatetypes/employee/delete/deleteemployee.html",controller:"ModalDeleteEmployeeCtrl",resolve:{parentScope:function(){return $scope},HomeService:function(){return HomeService},employee:function(){return employee},name:function(){return name},token:function(){return $rootScope.globals.currentUser.access_token},typeId:function(){return typeId}}})},$scope.assignAsset=function(asset,name){$modal.open({backdrop:!0,templateUrl:"../modules/templatetypes/asset/assign/linkasset.html",controller:"ModalAssignAssetCtrl",size:"lg",resolve:{parentScope:function(){return $scope},HomeService:function(){return HomeService},asset:function(){return asset},name:function(){return name},token:function(){return $rootScope.globals.currentUser.access_token}}})},$scope.removeLink=function(asset,name){$modal.open({backdrop:!0,templateUrl:"../modules/templatetypes/asset/unassign/removelink.html",controller:"ModalRemoveLinkCtrl",resolve:{parentScope:function(){return $scope},HomeService:function(){return HomeService},asset:function(){return asset},name:function(){return name},token:function(){return $rootScope.globals.currentUser.access_token}}})},$scope.setType=function(type){$scope.selectedType?($scope.selectedType.newCollapse=!1,type===$scope.selectedType?$scope.selectedType=null:($scope.selectedType=type,$scope.selectedType.newCollapse=!0)):($scope.selectedType=type,$scope.selectedType.newCollapse=!0)},$scope.isSelectedType=function(type){return type===$scope.selectedType?"list-group-item active":"list-group-item"},$scope.selectResource=function(resource){resource===$scope.selectedResource?$scope.selectedResource=null:$scope.selectedResource=resource},$scope.isSelectedResource=function(resource){return resource===$scope.selectedResource?"list-group-item active":"list-group-item"},$scope.isFilterdResource=function(resource){return resource===$scope.selectedResource?"glyphicon glyphicon-filter":""},$scope.loadPage()}]),angular.module("Home").filter("filterAssetMultiple",["$filter",function($filter){return function(items,values,type){if(values&&Array===values.constructor){var results=items;if(angular.forEach(values,function(value){value&&items&&Array===items.constructor&&(results=$filter("filter")(results,value))}),items&&Array===items.constructor&&values&&Array===values.constructor){type.searchSize=results.length;var checkedOut=0;angular.forEach(results,function(result){var linked=result.linkedResource;linked&&"unassigned"!==linked&&"employee deleted"!==linked&&(checkedOut+=1)}),type.checkedOut=checkedOut,type.checkedIn=type.searchSize-checkedOut,items=results.slice((type.currentPage-1)*type.itemsPerPage,type.currentPage*type.itemsPerPage)}}return items}}]),angular.module("Home").filter("filterResources",["$filter",function($filter){return function(items,values,pagination){if(values&&Array===values.constructor){var results=items;angular.forEach(values,function(value){value&&items&&Array===items.constructor&&(results=$filter("filter")(results,value))}),items&&Array===items.constructor&&values&&Array===values.constructor&&(pagination.searchSize=results.length,items=results.slice((pagination.currentPage-1)*pagination.itemsPerPage,pagination.currentPage*pagination.itemsPerPage))}return items}}]),angular.module("Home").directive("globalTypeSearch",function(){return{restrict:"EA",template:'<input type="text" class="form-control" placeholder="Search here" ng-model="inputValue" />',scope:{inputValue:"=",types:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){newValue&&newValue!==oldValue&&angular.forEach(scope.types,function(type){type.currentPage=1})})}}}),angular.module("Home").directive("typeSearch",function(){return{restrict:"EA",template:'<input type="text" class="form-control" placeholder="Search here" ng-model="inputValue" />',scope:{inputValue:"=",type:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){newValue&&newValue!==oldValue&&(scope.type.currentPage=1)})}}});