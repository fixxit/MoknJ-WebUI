"use strict";angular.module("Home").controller("ModalAssignAssetCtrl",function($scope,$modalInstance,parentScope,HomeService,asset,name,token){$scope.name="Check "+name+" Out",$scope.asset=asset,$scope.resources=[],$scope.selected="Select a Employee",$scope.resource={},$scope.pagination={},$scope.dropboxitemselected=function(resource){$scope.selected=resource.fullname,$scope.resource=resource,$scope.resourceCollapse=!$scope.resourceCollapse},$scope.loadPage=function(){HomeService.all(token,function(response){response?response.error_description?$scope.error=response.error_description+". Please logout!":response.resources?($scope.resources=response.resources,$scope.pagination.viewby=5,$scope.pagination.totalItems=$scope.resources.length,$scope.pagination.currentPage=1,$scope.pagination.itemsPerPage=5,$scope.pagination.maxSize=5,angular.forEach($scope.resources,function(entry){entry.fullname=entry.firstName+" "+entry.surname}),$scope.dataLoading=!1):$scope.error="Invalid server response":$scope.error="Invalid server response"})},$scope.isEven=function(value){return parentScope.isEven(value)},$scope.loadPage(),$scope.ok=function(){null==$scope.auditdate?($scope.showDateIsRequired=!0,$scope.error="Date is required"):($scope.showDateIsRequired=!1,$scope.error=null),"Select an Resource"===$scope.selected?($scope.showResourceIsRequired=!0,$scope.error="Employee is required"):($scope.showResourceIsRequired=!1,$scope.error=null),$scope.showResourceIsRequired||$scope.showDateIsRequired||($scope.dataLoading=!0,$scope.link={resourceId:$scope.resource.id,assetId:asset.id,date:$scope.auditdate,checked:!0},asset.resourceId=$scope.resource.id,HomeService.addLink(token,$scope.link,function(response){response?response.error_description?$scope.error=response.error_description+". Please logout!":response.success?(parentScope.refreshAsset(asset,!0),$modalInstance.close()):$scope.message=response.message:$scope.error="Invalid server response",$scope.dataLoading=!1}))},$scope.resourceCollapse=!1,$scope.changeDiv=function(){$scope.resourceCollapse=!$scope.resourceCollapse},$scope.openDatePickers=[],$scope.disabled=function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},$scope.openDate=function($event,datePickerIndex){$event.preventDefault(),$event.stopPropagation(),$scope.openDatePickers[datePickerIndex]===!0?$scope.openDatePickers.length=0:($scope.openDatePickers.length=0,$scope.openDatePickers[datePickerIndex]=!0)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("Home").controller("ModalDeleteAssetCtrl",function($scope,$modalInstance,parentScope,HomeService,asset,name,token,typeId){$scope.name=name,$scope.message="Are you sure you want to delete this asset ?",$scope.ok=function(){HomeService.deleteAsset(token,asset,function(response){response?response.error_description?$scope.error=response.error_description+". Please logout!":response.success?parentScope.removeAssetFromTemplate(typeId,asset):$scope.message=response.message:$scope.error="Invalid server response"}),$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("Link").factory("ApiLinkCall",["$http",function($http){var service={};return service.process=function(url,callback){$http.get("../settings.json").success(function(response){$http.post(response.api_url+url).success(function(response){callback(response)}).error(function(response){callback(response)})})},service}]),angular.module("Link").factory("LinkService",["ApiLinkCall",function(ApiLinkCall){var service={};return service.allLinkForAssetId=function(token,id,callback){ApiLinkCall.process("link/asset/all/"+id+"/asset?access_token="+token,callback)},service.allLinkForResourceId=function(token,id,callback){ApiLinkCall.process("link/asset/all/"+id+"/resource?access_token="+token,callback)},service.allLink=function(token,callback){ApiLinkCall.process("link/asset/all/?access_token="+token,callback)},service.getResource=function(token,id,callback){ApiLinkCall.process("resource/get/"+id+"?access_token="+token,callback)},service.getAsset=function(token,id,callback){ApiLinkCall.process("asset/get/"+id+"?access_token="+token,callback)},service.getDetail=function(token,id,callback){ApiLinkCall.process("type/get/"+id+"?access_token="+token,callback)},service}]),angular.module("Link").controller("LinkController",["$scope","$rootScope","$location","LinkService",function($scope,$rootScope,$location,LinkService){$scope.menuId=$location.search().menuId?$location.search().menuId:null,$scope.assetId=$location.search().assetId,$scope.resourceId=$location.search().resourceId,$scope.pagination={};var name=$location.search().name;$scope.loadPage=function(){$scope.loading=!0,name?$scope.name="Audit Trail "+name:$scope.name="Asset Audit Trail",$scope.assetId?$scope.getLinksByAssetId($scope.assetId):$scope.resourceId?$scope.getLinksByResourceId($scope.resourceId):$scope.getAllLinks(),$scope.loading=!1},$scope.process=function(response){response?response.error_description?"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!"):($scope.links=response.links,$scope.pagination.viewby=10,$scope.pagination.totalItems=$scope.links.length,$scope.pagination.currentPage=1,$scope.pagination.itemsPerPage=10,$scope.pagination.maxSize=10,$scope.dataLoading=!1,angular.forEach($scope.links,function(link){$scope.loadResource(link,function(response){response.resource?(link.linkedResource=response.resource.firstName+" "+response.resource.surname,link.resource=response.resource):(link.linkedResource="deleted employee",link.resource=null),response.error_description&&("Access is denied"!==response.error_description?$scope.error=response.error_description+". Please logout!":(link.linkedResource="no access",link.resource=null))}),$scope.loadAsset(link,function(response){response.asset&&$scope.loadAssetDetails(response.asset,link),response.error_description&&("Access is denied"!==response.error_description?$scope.error=response.error_description+". Please logout!":link.display="no access")}),link.date=$scope.formatDate(new Date(link.date)),link.checked?link.checkedDir="CHECKED-OUT":link.checkedDir="CHECKED-IN",$scope.loading=!1})):$scope.error="Invalid server response"},$scope.getLinksByAssetId=function(assetId){LinkService.allLinkForAssetId($rootScope.globals.currentUser.access_token,assetId,$scope.process)},$scope.getLinksByResourceId=function(resourceId){LinkService.allLinkForResourceId($rootScope.globals.currentUser.access_token,resourceId,$scope.process)},$scope.getAllLinks=function(){LinkService.allLink($rootScope.globals.currentUser.access_token,$scope.process)},$scope.loadResource=function(link,callback){link.resourceId&&($scope.loading=!0,LinkService.getResource($rootScope.globals.currentUser.access_token,link.resourceId,function(response){callback(response)}),$scope.loading=!1)},$scope.formatDate=function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString();month=month.length>1?month:"0"+month;var day=date.getDate().toString();return day=day.length>1?day:"0"+day,year+"-"+month+"-"+day},$scope.stripTrailing=function(str,trimStr){str.substr(0,1)===trimStr&&(str=str.substring(1));var len=str.length;return str.substr(len-1,1)===trimStr&&(str=str.substring(0,len-1)),str},$scope.loadAsset=function(link,callback){link.assetId&&LinkService.getAsset($rootScope.globals.currentUser.access_token,link.assetId,function(response){callback(response)})},$scope.loadAssetDetails=function(asset,link){link.display="",asset&&asset.typeId&&LinkService.getDetail($rootScope.globals.currentUser.access_token,asset.typeId,function(response){if($scope.loading=!0,response)if(response.error_description)"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!");else if(response.type){$scope.type=response.type;var value="";angular.forEach(asset.details,function(field){angular.forEach($scope.type.details,function(detail){detail.id===field.id&&field.value&&detail.display&&("GBL_INPUT_DAT_TYPE"===field.type&&(field.value=$scope.formatDate(new Date(field.value))),value=value+field.value+",")})}),value&&(value=" ("+$scope.stripTrailing(value,",")+")"),link.display=$scope.type.name+value}$scope.loading=!1})},$scope.formatDate=function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString();month=month.length>1?month:"0"+month;var day=date.getDate().toString();return day=day.length>1?day:"0"+day,year+"-"+month+"-"+day},$scope.isEven=function(value){return value%2===0?"":"active"},$scope.getCheckedClass=function(checked){return checked?"glyphicon glyphicon-arrow-left":"glyphicon glyphicon-arrow-right"},$scope.loadPage()}]),angular.module("Link").filter("filterMultiple",["$filter",function($filter){return function(items,values,pagination){if(values&&Array===values.constructor){var results=items;angular.forEach(values,function(value){value&&items&&Array===items.constructor&&(results=$filter("filter")(results,value))}),items&&Array===items.constructor&&values&&Array===values.constructor&&(pagination.searchSize=results.length,items=results.slice((pagination.currentPage-1)*pagination.itemsPerPage,pagination.currentPage*pagination.itemsPerPage))}return items}}]),angular.module("Asset").factory("ApiAssetCall",["$http",function($http){var service={};return service.process=function(url,payload,callback){$http.get("../settings.json").success(function(response){payload?$http({method:"POST",url:response.api_url+url,data:JSON.stringify(payload),headers:{"Content-Type":"application/json"}}).success(function(response){callback(response)}).error(function(response){callback(response)}):$http.post(response.api_url+url).success(function(response){callback(response)}).error(function(response){callback(response)})})},service}]),angular.module("Asset").factory("AssetService",["ApiAssetCall",function(ApiAssetCall){var service={};return service.getDetail=function(token,id,callback){ApiAssetCall.process("type/get/"+id+"?access_token="+token,null,callback)},service.get=function(token,id,callback){ApiAssetCall.process("asset/get/"+id+"?access_token="+token,null,callback)},service.save=function(token,id,data,callback){ApiAssetCall.process("asset/add/"+id+"?access_token="+token,data,callback)},service}]),angular.module("Asset").controller("AssetController",["$scope","$rootScope","$location","AssetService",function($scope,$rootScope,$location,AssetService){$scope.menuId=$location.search().menuId?$location.search().menuId:null,$scope.assetId=$location.search().assetId;var id=$location.search().id;$scope.name="",$scope.dropboxitemselected=function(item,detail){detail.value=item},$scope.loadPage=function(id){id&&AssetService.getDetail($rootScope.globals.currentUser.access_token,id,function(response){response?response.error_description?"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!"):response.type?($scope.type=response.type,angular.forEach($scope.type.details,function(detail){if("GBL_INPUT_DRP_TYPE"===detail.type){var n=detail.name.indexOf(":"),name=detail.name.substring(0,n),json=detail.name.substring(n+1,detail.name.length);detail.name=name,detail.dropdownvalues=JSON.parse(json),detail.value="no selection"}}),$scope.name=$scope.type.name,$scope.assetId&&AssetService.get($rootScope.globals.currentUser.access_token,$scope.assetId,function(response){response?response.error_description?$scope.error=response.error_description+". Please logout!":response.asset?($scope.asset=response.asset,angular.forEach($scope.asset.details,function(asset){angular.forEach($scope.type.details,function(detail){detail.id===asset.id&&(detail.value=asset.value)})}),$scope.type.resourceId=response.asset.resourceId,$scope.type.menuScopeIds=response.asset.menuScopeIds,$scope.dataLoading=!1):$scope.error="Invalid server response":$scope.error="Invalid server response"}),$scope.dataLoading=!1):$scope.error="Invalid server response":$scope.error="Invalid server response"})},$scope.loadPage(id),$scope.openDatePickers=[],$scope.disabled=function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},$scope.openCal=function($event,datePickerIndex){$event.preventDefault(),$event.stopPropagation(),$scope.openDatePickers[datePickerIndex]===!0?$scope.openDatePickers.length=0:($scope.openDatePickers.length=0,$scope.openDatePickers[datePickerIndex]=!0)},$scope.stripTrailing=function(str,trimStr){str.substr(0,1)===trimStr&&(str=str.substring(1));var len=str.length;return str.substr(len-1,1)===trimStr&&(str=str.substring(0,len-1)),str},$scope.save=function(){if(id){$scope.assetId?$scope.type.id=$scope.assetId:$scope.type.id=null,$scope.type.menuScopeIds||($scope.type.menuScopeIds=[$scope.menuId]);var missingValue="";angular.forEach($scope.type.details,function(detail){!detail.mandatory||detail&&""!==detail.value&&"no selection"!==detail.value||(missingValue=missingValue+detail.name+",")}),missingValue&&(missingValue=$scope.stripTrailing(missingValue,",")),missingValue?$scope.error="Please provide values for "+missingValue:AssetService.save($rootScope.globals.currentUser.access_token,id,$scope.type,function(response){response.error_description?($scope.success=null,"Access is denied"!==response.error_description?$scope.error=response.error_description+". Please logout!":$scope.error=response.error_description+". Please contact your administrator."):response.success===!0?($scope.assetId?$scope.menuId?$location.path("/home").search({id:$scope.menuId}):$location.path("/home"):$scope.success="Successfully saved asset, save new asset ?",$scope.error=null,$scope.dataLoading=!1,$scope.reset(!1)):($scope.success=null,$scope.error=response.message)})}},$scope.reset=function(clear){$scope.error=null,clear&&($scope.success=null),angular.forEach($scope.type.details,function(detail){detail.value=null,"GBL_INPUT_DRP_TYPE"===detail.type&&(detail.value="no selection")})}}]),angular.module("Asset").directive("moneyOnlyInput",function(){return{restrict:"EA",template:'<input name="{{inputName}}" ng-model="inputValue" class="form-control" />',scope:{inputValue:"=",inputName:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){if(newValue){var arr=String(newValue).split("");if(0===arr.length)return;if(1===arr.length&&("-"===arr[0]||"."===arr[0]))return;if(2===arr.length&&"-."===newValue)return;isNaN(newValue)&&(oldValue?scope.inputValue=oldValue:scope.inputValue="")}})}}}),angular.module("Asset").directive("moneyOnlyInputRequired",function(){return{restrict:"EA",template:'<input name="{{inputName}}" ng-model="inputValue" class="form-control" required />',scope:{inputValue:"=",inputName:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){if(newValue){var arr=String(newValue).split("");if(0===arr.length)return;if(1===arr.length&&("-"===arr[0]||"."===arr[0]))return;if(2===arr.length&&"-."===newValue)return;isNaN(newValue)&&(oldValue?scope.inputValue=oldValue:scope.inputValue="")}})}}}),angular.module("Asset").directive("numberOnlyInput",function(){return{restrict:"EA",template:'<input name="{{inputName}}" ng-model="inputValue" class="form-control" />',scope:{inputValue:"=",inputName:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){if(newValue){var arr=String(newValue).split("");if(0===arr.length)return;if(1===arr.length&&("-"===arr[0]||"."===arr[0]))return;if(2===arr.length&&"-."===newValue)return;isNaN(newValue)?oldValue?scope.inputValue=oldValue:scope.inputValue="":scope.inputValue=parseInt(Number(newValue))}})}}}),angular.module("Asset").directive("numberOnlyInputRequired",function(){return{restrict:"EA",template:'<input name="{{inputName}}" ng-model="inputValue" class="form-control" required/>',scope:{inputValue:"=",inputName:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){if(newValue){var arr=String(newValue).split("");if(0===arr.length)return;if(1===arr.length&&("-"===arr[0]||"."===arr[0]))return;if(2===arr.length&&"-."===newValue)return;isNaN(newValue)?oldValue?scope.inputValue=oldValue:scope.inputValue="":scope.inputValue=parseInt(Number(newValue))}})}}}),angular.module("Home").controller("ModalRemoveLinkCtrl",function($scope,$modalInstance,parentScope,HomeService,asset,name,token){$scope.name="Check "+name+" In",$scope.ok=function(){$scope.dataLoading=!0,$scope.link={resourceId:asset.resourceId,assetId:asset.id,date:$scope.auditdate,checked:!1},HomeService.addLink(token,$scope.link,function(response){response?response.error_description?$scope.error=response.error_description+". Please logout!":response.success?(parentScope.refreshAsset(asset,!1),$modalInstance.close()):$scope.message=response.message:$scope.error="Invalid server response"})},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.openDatePickers=[],$scope.disabled=function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},$scope.openDate=function($event,datePickerIndex){$event.preventDefault(),$event.stopPropagation(),$scope.openDatePickers[datePickerIndex]===!0?$scope.openDatePickers.length=0:($scope.openDatePickers.length=0,$scope.openDatePickers[datePickerIndex]=!0)}});