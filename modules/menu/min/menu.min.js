"use strict";angular.module("Menu").factory("ApiMenuCall",["$http",function($http){var service={};return service.process=function(url,payload,callback){$http.get("../settings.json").success(function(response){payload?$http({method:"POST",url:response.api_url+url,data:JSON.stringify(payload),headers:{"Content-Type":"application/json"}}).success(function(response){callback(response)}).error(function(response){callback(response)}):$http.post(response.api_url+url).success(function(response){callback(response)}).error(function(response){callback(response)})})},service}]),angular.module("Menu").factory("MenuService",["ApiMenuCall",function(ApiMenuCall){var service={};return service.getAllTypes=function(token,callback){ApiMenuCall.process("type/all?access_token="+token,null,callback)},service.getMenu=function(token,id,callback){ApiMenuCall.process("menu/get/"+id+"?access_token="+token,null,callback)},service.deleteMenu=function(token,id,callback){ApiMenuCall.process("menu/delete/"+id+"?access_token="+token,null,callback)},service.saveMenu=function(token,menu,callback){ApiMenuCall.process("menu/add?access_token="+token,menu,callback)},service.getAllMenus=function(token,callback){ApiMenuCall.process("menu/all?access_token="+token,null,callback)},service.getAllModules=function(token,callback){ApiMenuCall.process("menu/module/types?access_token="+token,null,callback)},service}]),angular.module("Menu").controller("MenuController",["$scope","$rootScope","$location","MenuService","$modal",function($scope,$rootScope,$location,MenuService,$modal){$scope.menuId=$location.search().menuId?$location.search().menuId:null,$scope.new=$location.search().new?$location.search().new:null,$scope.type=$location.search().type?$location.search().type:null,$scope.menu={templates:[]},$scope.pagination={},$scope.newCollapse=!1,$scope.menus=[],$scope.loadPage=function(){$scope.loadTemplates(),$scope.loadMenus(),$scope.loadModules(),$scope.new&&($scope.newCollapse=!0)},$scope.loadMenus=function(){MenuService.getAllMenus($rootScope.globals.currentUser.access_token,function(response){response.error_description?$scope.error=response.error_description+". Please logout!":response.menus&&($scope.menus=response.menus,$scope.pagination.totalItems=response.menus.length,$scope.pagination.currentPage=1,$scope.pagination.itemsPerPage=10,$scope.pagination.maxSize=10,$scope.pagination.viewby=10)})},$scope.loadTemplates=function(){MenuService.getAllTypes($rootScope.globals.currentUser.access_token,function(response){response&&(response.error_description?"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!"):response.types&&($scope.types=response.types))})},$scope.loadModules=function(){MenuService.getAllModules($rootScope.globals.currentUser.access_token,function(response){response&&(response.error_description?"Access is denied"!==response.error_description&&($scope.error=response.error_description+". Please logout!"):response.menuTypes&&($scope.menuTypes=response.menuTypes,$scope.type&&angular.forEach($scope.menuTypes,function(menu){if($scope.type===menu.name){var index=$scope.menuTypes.indexOf(menu);$scope.menu.menuType=$scope.menuTypes[index]}})))})},$scope.remove=function(index){var item=$scope.menu.templates[index];$scope.menu.templates.splice($scope.menu.templates.indexOf(item),1)},$scope.move=function(old_index,new_index){for(;old_index<0;)old_index+=$scope.menu.templates.length;for(;new_index<0;)new_index+=$scope.menu.templates.length;if(new_index>=this.length)for(var k=new_index-$scope.menu.templates.length;k--+1;)$scope.menu.templates.push(void 0);$scope.menu.templates.splice(new_index,0,$scope.menu.templates.splice(old_index,1)[0])},$scope.selectIndex=null,$scope.edit=function(index){$scope.selectIndex=index,$scope.template=$scope.menu.templates[index]},$scope.add=function(){if($scope.template){var index=$scope.menu.templates.indexOf($scope.template),hasValue=(parseInt(index)>=0||parseInt(index)!==-1)&&null==$scope.selectIndex;hasValue?$scope.pageError="No duplicate templates allowed in template list":($scope.template.allowScopeChallenge=$scope.allowScopeChallenge,null==$scope.selectIndex?$scope.menu.templates.push($scope.template):($scope.menu.templates[$scope.selectIndex]=$scope.template,$scope.selectIndex=null),$scope.pageError=null,$scope.template=null)}else $scope.pageError="Please select a template for your template list"},$scope.cancel=function(){$scope.template=null,$scope.pageError=null,$scope.selectIndex=null},$scope.reset=function(messages){$scope.menu={templates:[]},$scope.id=null,messages&&($scope.success=null,$scope.error=null)},$scope.editMenu=function(id){$scope.id=id,MenuService.getMenu($rootScope.globals.currentUser.access_token,id,function(response){response.error_description?($scope.success=null,$scope.error=response.error_description):($scope.menu=response.menu,$scope.menu.templates&&(angular.forEach($scope.menu.templates,function(template){$scope.types&&angular.forEach($scope.types,function(type){if(template.id===type.id){var index=$scope.types.indexOf(type);$scope.types[index]=template}})}),$scope.menuTypes&&angular.forEach($scope.menuTypes,function(menu){if($scope.menu.menuType===menu.name){var index=$scope.menuTypes.indexOf(menu);$scope.menu.menuType=$scope.menuTypes[index]}})),$scope.newCollapse=!0)})},$scope.submit=function(){$scope.menu.menuType=$scope.menu.menuType.name,MenuService.saveMenu($rootScope.globals.currentUser.access_token,$scope.menu,function(response){response.error_description?($scope.success=null,$scope.error=response.error_description+". Please logout!"):response.success?($scope.success="Successfully saved a new menu item, create new menu item ?",$scope.error=null,$scope.dataLoading=!1,$scope.loadMenus(),$scope.reset()):($scope.success=null,$scope.error=response.message)})},$scope.isEven=function(value){return value%2===0?"":"active"},$scope.isExpanded=function(){return $scope.newCollapse?"glyphicon glyphicon-collapse-up":"glyphicon glyphicon-collapse-down"},$scope.deleteMenu=function(menu,callback){MenuService.deleteMenu($rootScope.globals.currentUser.access_token,menu.id,function(response){response.error_description?callback(!1,response.error_description):callback(!0)})},$scope.removeFromList=function(menu){var index=$scope.menus.indexOf(menu);$scope.menus.splice(index,1)},$scope.removeMenu=function(menu){$modal.open({backdrop:!0,templateUrl:"../modules/menu/templates/deletemenu.html",controller:"ModalDeleteMenuCtrl",resolve:{parentScope:function(){return $scope},menu:function(){return menu}}})},$scope.loadPage()}]),angular.module("Menu").controller("ModalDeleteMenuCtrl",function($scope,$modalInstance,parentScope,menu){$scope.name=menu.name,$scope.accept=!1,$scope.errorMessage=!1,$scope.message="",$scope.ok=function(){$scope.errorMessage=!1,$scope.dataLoading=!0,parentScope.deleteMenu(menu,function(success,message){success?(parentScope.removeFromList(menu),$modalInstance.close()):($scope.errorMessage=!0,$scope.message=message)})},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("Menu").filter("filterMenus",["$filter",function($filter){return function(items,value,pagination){var results=items;return value&&(results=$filter("filter")(results,value)),pagination.searchSize=results.length,items=results.slice((pagination.currentPage-1)*pagination.itemsPerPage,pagination.currentPage*pagination.itemsPerPage)}}]),angular.module("Menu").directive("searchMenus",function(){return{restrict:"EA",template:'<input type="text" class="form-control" placeholder="Search here" ng-model="inputValue" />',scope:{inputValue:"=",pageValue:"="},link:function(scope){scope.$watch("inputValue",function(newValue,oldValue){newValue&&newValue!==oldValue&&(scope.pageValue.currentPage=1)})}}});